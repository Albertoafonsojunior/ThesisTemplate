%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Basic configuration
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Use 'KOMA-Script Book' as the document class
\documentclass[toc=bibliography,toc=indentunnumbered]{scrbook} 

% All modern documents should start with this (unless you use XeTeX/LuaTeX)
\usepackage[utf8]{inputenc}      % UTF-8 file encoding
\usepackage[T1]{fontenc}         % 8-bit font encoding

% This package is useful for modding standard environments
\usepackage{etoolbox}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Page design
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Font size
\KOMAoptions{fontsize=11pt}

% Line spacing
\linespread{1.05}

% Paper format
\KOMAoptions{paper=B5}

% Duplex layout
\KOMAoptions{twoside}

% Page layout (ISO B5 aspect ratio)
%\KOMAoptions{BCOR=6mm}
%\KOMAoptions{DIV=11}

% Page layout (Golden aspect ratio)
\areaset[6mm]{358.40pt}{579.89pt} 

% Disable headers
\pagestyle{plain}

% Page numbers
\addtokomafont{pagenumber}{\vspace{3.5ex}\footnotesize\sffamily\bfseries}

% Left-justify equations
\PassOptionsToPackage{fleqn}{amsmath}

% Use spacing instead of indentation to separate paragraphs
%\KOMAoptions{parskip=half+} 



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Document fonts
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Palatino serif font (main text font)
\usepackage[largesc]{newpxtext}

% Kepler serif font (main text font)
%\usepackage{kpfonts}

% Optima sans font (titles, captions, footnotes, and links)
%\usepackage{classico}

% Biolinum sans font (titles, captions, footnotes, and links)
\usepackage[scaled=1.07]{biolinum}

% Euler mathematical font (math)
\usepackage[utf8]{eulerpx/eulerpx}

% Vera monospaced font (code)
\usepackage[scaled=0.84]{beramono}

% Enable microtypographic tweaks
\usepackage{microtype}


 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Table of contents
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
% Load a package for styling the table of contents
\usepackage{tocstyle}

% Place page numbers right after the section entries
\usetocstyle{nopagecolumn}

% Do not include subsections in the table of contents
\setcounter{tocdepth}{1}

% Use tabular lining figures for the sections, but oldstyle figures for the pages
\settocstylefeature{entryhook}{\tlfstyle}
\settocstylefeature{pagenumberhook}{\osfstyle}
\settocstylefeature[0]{entryhook}{\tlfstyle\bfseries}
\settocstylefeature[0]{pagenumberhook}{\osfstyle\bfseries}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Headings
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Make sure all headings use sans text and math
\addtokomafont{disposition}{\sffamily}

% Change the sizes of chapters and sections
\addtokomafont{chapter}{\huge}
\addtokomafont{section}{\large}

% Change spacing around chapters and sections
\RedeclareSectionCommand[beforeskip=-0.0\baselineskip,afterskip=0.7\baselineskip]{chapter}
\RedeclareSectionCommand[beforeskip=-1.0\baselineskip,afterskip=0.5\baselineskip]{section}

% Bringhurst-style chapter numbers
\makeatletter
\newsavebox{\feline@chapter}
\newcommand\feline@chapter@marker[1][4cm]{\sbox\feline@chapter{\resizebox{!}{#1}{\setlength{\fboxsep}{0pt}\colorbox{white}{\color{gray}\thechapter}}}\usebox{\feline@chapter}}
\renewcommand*{\chapterformat}{\sbox\feline@chapter{\feline@chapter@marker[1.6cm]}\makebox[0pt][l]{\makebox[\dimexpr\textwidth+\marginparsep+\wd\feline@chapter\relax][r]{\usebox\feline@chapter}}}
\makeatother

% Hanging chapter titles
\renewcommand*{\chapterheadstartvskip}{\hspace*{-1.1\parindent}}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Captions
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Switch to a sans font for captions
\addtokomafont{caption}{\sffamily\small}

% Use a bold font for caption labels
\addtokomafont{captionlabel}{\sffamily\bfseries\small}

% Redefine the caption label delimiter
%\renewcommand*{\captionformat}{\hspace{0.3em}\rule[-0.30ex]{0.085em}{1.80ex}\hspace{0.3em}}

% Add 2em margins on each side of the caption. (Since the default \parindent is 1em, this
% implies that the left end of the caption will always look one \parindent indented if it
% comes right before/after a new paragraph, and can therefore prevent weird indentation.)
\setcapdynwidth{\dimexpr\textwidth-4em\relax}

% Disable extra indentation of the subsequent lines in a multiline caption
\setcapindent{0em}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Footnotes
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Make sure footnote marks are separated by commas and kerned properly
\usepackage{fnpct}

% Switch to a sans font for footnotes
\addtokomafont{footnote}{\sffamily}

% Change footnote marks to letters (recommended if using superscript citations)
%\renewcommand{\thefootnote}{\alph{footnote}}

% Set the footnote rule length to the text width
\setfootnoterule{\textwidth}

% Disable the footnote rule entirely
%\setfootnoterule{0pt}

% Adjust the footnote size and spacing
\deffootnote{1em}{1em}{\textsuperscript{\thefootnotemark}\kern0.1em}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Hyperlinks
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Enable clickable hyperlinks (useful if the document is read on a computer)
\usepackage{hyperref}

% Do not color links (suitable for documents that will primarily be printed)
\hypersetup{hidelinks}

% Generate links in the table of contents
\hypersetup{linktoc=all}

% Generate links to footnotes
\hypersetup{hyperfootnotes}

% Generate PDF bookmarks (also useful if the document is read on a computer)
\hypersetup{bookmarks,bookmarksopen,bookmarksnumbered}

% Switch to a sans font for hyperlinks
\urlstyle{sf}

% Fix kerning problems for backslashes and redefine underscores in hyperlinks
\makeatletter
\let\UrlSpecialsOld\UrlSpecials
\def\UrlSpecials{\UrlSpecialsOld\do\/{\Url@slash}\do\_{\Url@underscore}}%
\def\Url@slash{\@ifnextchar/{\kern+0.05em\mathchar47\kern-0.10em}%
    {\kern0.08em\mathchar47\penalty\UrlBigBreakPenalty}}
\def\Url@underscore{\nfss@text{\leavevmode \kern.06em\vbox{\hrule height 0.12ex width 0.4em}}}
\makeatother




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   References
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Bibliography backend (e.g. 'biber' or 'bibtex')
\PassOptionsToPackage{backend=biber}{biblatex}

% Bibliography style (e.g. 'phys' or 'nature')
\PassOptionsToPackage{style=phys}{biblatex}

% Citation style (e.g. 'plain' or 'superscript')
\PassOptionsToPackage{autocite=plain}{biblatex}

% Bibentry style (e.g. 'brackets' or 'superscript')
\PassOptionsToPackage{biblabel=brackets}{biblatex}

% Customize which fields to show in the bibliography
\PassOptionsToPackage{articletitle=true}{biblatex}
\PassOptionsToPackage{chaptertitle=true}{biblatex}
\PassOptionsToPackage{pageranges=false}{biblatex}

% Use ampersand as the author delimiter
%\renewcommand*{\finalnamedelim}{\ifnumgreater{\value{liststop}}{2}{\finalandcomma}{}\addspace\&\space}

% Format for cross-references with \cref
\PassOptionsToPackage{noabbrev}{cleveref}
\newcommand{\crefrangeconjunction}{--}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Load packages
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Load the required packages
\usepackage{amsmath}    % Common mathematical environments
\usepackage{biblatex}   % Produces the bibliography
\usepackage{cleveref}   % Easy and consistent cross-references
\usepackage{graphicx}   % Loads and displays figures
\usepackage{pdfpages}   % Enables embedding of documents
\usepackage{xcolor}     % Enables coloring of text and pages
\usepackage{booktabs}   % Proper formatting of tables
\usepackage{siunitx}    % Proper formatting of units
\usepackage{mhchem}     % Proper formatting of chemicals
\usepackage{bm}         % Vector notation
\usepackage{lipsum}     % Filler text



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Miscellaneous
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Set tables in a sans font
\AtBeginEnvironment{tabular}{\sffamily}
\AtBeginEnvironment{tabular*}{\sffamily}

% Format for typesetting physical units
\sisetup{range-units=single}
\sisetup{range-phrase=--}
\sisetup{detect-all} 

% Use 2em equation indentation
\makeatletter
\setlength\@mathmargin{2em}
\makeatother

% Replace \cite with the more flexible \autocite
\let\cite=\autocite

% Define custom colors
\definecolor{ghostwhite}{rgb}{0.97, 0.97, 1.00}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Custom macros
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Mathematical objects
\newcommand{\tensor}[1]{\overset{\text{\scriptsize$\leftrightarrow$}}{#1}}

% Macro for including papers
\newcounter{papercount}
\newenvironment{paper}[1]
{
  \large
  \def\paperpath{#1}
  \stepcounter{papercount}
  \chapter*{Paper \#\arabic{papercount}}
  \pagecolor{ghostwhite}
  \noindent\\[-2ex]
}
{
  \cleardoublepage
  \nopagecolor
  \includepdf[pages={-}]{\paperpath}
  \cleardoublepage
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   Document itself
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\addbibresource{library.bib}

\begin{document}

\frontmatter
  \include{chapters/abstract}
  \include{chapters/preface}
  \tableofcontents
\mainmatter 
  \include{chapters/introduction} 
  \include{chapters/theory} 
  \include{chapters/algorithms} 
  \include{chapters/test}
\backmatter
  \printbibliography
  \include{papers/include}

\end{document}
